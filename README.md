# Docker Swarm Stack Deployment Manager

A comprehensive shell script for managing Docker Swarm stack deployments with automated configuration and deployment.

## ğŸš€ Features

- **Interactive Configuration**: Guided setup with sensible defaults
- **Automatic .env Generation**: Creates environment files based on your inputs
- **Docker Swarm Integration**: Full support for Docker Swarm deployments
- **Secure Credentials**: Proper password hashing and secure storage
- **Multiple Deployment Modes**: CLI commands or interactive menu
- **Stack Management**: Deploy, remove, and monitor stacks easily

## ğŸ“‹ Prerequisites

Before using this script, ensure you have:

1. **Ubuntu Server** (or compatible Linux distribution)
2. **Docker** installed and running
3. **Docker Swarm** initialized
4. **Domain name** configured with DNS provider
5. **Cloudflare account** (for Traefik SSL certificates)

### Quick Prerequisites Setup

```bash
# Install Docker (if not already installed)
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Add your user to docker group
sudo usermod -aG docker $USER
newgrp docker

# Initialize Docker Swarm
docker swarm init

# Install htpasswd (optional but recommended)
sudo apt update
sudo apt install -y apache2-utils
```

## ğŸ“¦ Currently Supported Stacks

- **Traefik**: Reverse proxy and load balancer with automatic SSL
- **Portainer**: Docker management UI

## ğŸ¯ Quick Start

### Option 1: Deploy Everything (Recommended)

```bash
./deploy.sh all
```

This will:
1. Ask for your main domain
2. Configure Traefik (with Cloudflare API credentials)
3. Configure Portainer
4. Deploy both stacks
5. Provide access URLs and next steps

### Option 2: Deploy Individual Stacks

```bash
# Deploy only Traefik
./deploy.sh traefik

# Deploy only Portainer
./deploy.sh portainer
```

### Option 3: Interactive Menu

```bash
./deploy.sh
```

This will present an interactive menu with all available options.

## ğŸ“– Usage Guide

### Initial Deployment

1. **Prepare Your Information**:
   - Main domain (e.g., `vagifgozalov.com`)
   - Cloudflare email address (e.g., `webmaster@avvaagency.com`)
   - Cloudflare DNS API token
   - Desired username/password for Traefik dashboard

2. **Run the Deployment Script**:
   ```bash
   ./deploy.sh all
   ```

3. **Follow the Prompts**:
   - Enter your main domain when prompted (default: vagifgozalov.com)
   - Provide Cloudflare credentials (default email: webmaster@avvaagency.com)
   - Set Traefik dashboard username and password
   - Accept defaults for Portainer ports or customize them

4. **Configure DNS**:
   Add these DNS records in your domain provider (Cloudflare):
   ```
   Type: A
   Name: traefik
   Content: YOUR_SERVER_IP
   Proxy: Yes (Orange Cloud)

   Type: A
   Name: portainer
   Content: YOUR_SERVER_IP
   Proxy: Yes (Orange Cloud)
   ```

5. **Access Your Services**:
   - Traefik: `https://traefik.yourdomain.com`
   - Portainer: `https://portainer.yourdomain.com`

### Managing Stacks

#### List Deployed Stacks
```bash
./deploy.sh list
# or
./deploy.sh ls
```

#### Check Status
```bash
./deploy.sh status
```

This shows:
- All deployed stacks
- All running services
- Docker networks

#### View Service Logs
```bash
./deploy.sh logs <service_name>

# Example:
./deploy.sh logs traefik_traefik
./deploy.sh logs portainer_portainer
```

#### Remove a Stack
```bash
./deploy.sh remove <stack_name>

# Example:
./deploy.sh remove traefik
./deploy.sh remove portainer
```

## ğŸ” Security Considerations

### Traefik Dashboard Authentication

The script automatically generates a secure htpasswd hash for Traefik dashboard access. You'll set:
- Username (default: `admin`)
- Password (your choice, prompted securely)

### Cloudflare API Token

To create a Cloudflare API token:

1. Log in to Cloudflare Dashboard
2. Go to **My Profile** > **API Tokens**
3. Click **Create Token**
4. Use the **Edit zone DNS** template
5. Set permissions:
   - Zone / DNS / Edit
6. Include your specific zone
7. Create token and copy it

### Environment Files

The script creates `.env` files in each stack directory containing sensitive information:
- These files are gitignored by default
- Keep them secure and never commit to version control

## ğŸ“ Directory Structure

```
neo/
â”œâ”€â”€ deploy.sh                 # Main deployment script
â”œâ”€â”€ README.md                 # This file
â””â”€â”€ stacks/
    â”œâ”€â”€ traefik/
    â”‚   â”œâ”€â”€ docker-compose.yml
    â”‚   â”œâ”€â”€ environment.example
    â”‚   â”œâ”€â”€ .env              # Generated by script
    â”‚   â”œâ”€â”€ acme.json         # SSL certificates
    â”‚   â””â”€â”€ traefik.yml       # Traefik configuration
    â””â”€â”€ portainer/
        â”œâ”€â”€ docker-compose.yml
        â”œâ”€â”€ environment.example
        â”œâ”€â”€ .env              # Generated by script
        â””â”€â”€ data/             # Portainer data
```

## ğŸ› ï¸ Troubleshooting

### Docker Swarm Not Initialized

**Error**: `Docker Swarm is not initialized!`

**Solution**:
```bash
docker swarm init
```

### Cannot Connect to Docker Daemon

**Error**: `Cannot connect to Docker daemon`

**Solution**:
```bash
# Add your user to docker group
sudo usermod -aG docker $USER

# Log out and log back in, or run:
newgrp docker
```

### Service Not Starting

**Check service logs**:
```bash
./deploy.sh logs traefik_traefik
./deploy.sh logs portainer_portainer
```

**Check service status**:
```bash
docker service ps traefik_traefik --no-trunc
docker service ps portainer_portainer --no-trunc
```

### SSL Certificate Issues

If SSL certificates are not being issued:

1. Verify DNS is pointing to your server:
   ```bash
   dig traefik.yourdomain.com
   ```

2. Check Cloudflare API token permissions

3. View Traefik logs:
   ```bash
   ./deploy.sh logs traefik_traefik
   ```

4. Ensure acme.json has correct permissions:
   ```bash
   chmod 600 stacks/traefik/acme.json
   ```

### Port Already in Use

If ports 80/443 are already in use:

```bash
# Check what's using the ports
sudo netstat -tulpn | grep :80
sudo netstat -tulpn | grep :443

# Stop the conflicting service
sudo systemctl stop apache2  # or nginx, or whatever is using the port
```

## ğŸ”„ Updating Stacks

To update a stack to a newer version:

```bash
# Remove the old stack
./deploy.sh remove traefik

# Wait for cleanup
sleep 10

# Redeploy with the same configuration
./deploy.sh traefik
```

The script will reuse your existing `.env` configuration.

## ğŸ“ Command Reference

| Command | Description |
|---------|-------------|
| `./deploy.sh all` | Deploy all stacks (Traefik + Portainer) |
| `./deploy.sh traefik` | Deploy only Traefik |
| `./deploy.sh portainer` | Deploy only Portainer |
| `./deploy.sh list` | List deployed stacks |
| `./deploy.sh status` | Show detailed status |
| `./deploy.sh remove <stack>` | Remove a stack |
| `./deploy.sh logs <service>` | View service logs |
| `./deploy.sh help` | Show help message |
| `./deploy.sh` | Interactive menu mode |

## ğŸš§ Adding More Stacks

The script is designed to be easily extensible. To add a new stack in the future:

1. Create a new directory in `stacks/`
2. Add `docker-compose.yml` and `environment.example`
3. Add configuration and deployment functions in `deploy.sh`
4. Update the menu and help text

The maintainer will add more stacks as needed.

## ğŸ“ Support

For issues or questions:
- Check the Troubleshooting section
- Review Docker Swarm logs: `docker service ls`
- Check individual service logs: `./deploy.sh logs <service_name>`

## ğŸ“„ License

This deployment script is provided as-is for managing Docker Swarm deployments.

---

**Last Updated**: November 2025
**Version**: 1.0.0
**Supported Stacks**: Traefik, Portainer

