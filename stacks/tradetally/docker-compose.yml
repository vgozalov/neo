version: '3.8'

services:
  tradetally-postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=${TRADETALLY_DB_NAME}
      - POSTGRES_USER=${TRADETALLY_DB_USER}
      - POSTGRES_PASSWORD=${TRADETALLY_DB_PASSWORD}
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    networks:
      - tradetally-internal
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

  tradetally-redis:
    image: redis:7-alpine
    volumes:
      - tradetally_redis_data:/data
    networks:
      - tradetally-internal
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  tradetally:
    image: ${TRADETALLY_IMAGE}
    depends_on:
      - tradetally-postgres
      - tradetally-redis
    environment:
      - NODE_ENV=${TRADETALLY_NODE_ENV}
      - PORT=${TRADETALLY_APP_PORT}
      - DB_HOST=tradetally-postgres
      - DB_PORT=5432
      - DB_USER=${TRADETALLY_DB_USER}
      - DB_PASSWORD=${TRADETALLY_DB_PASSWORD}
      - DB_NAME=${TRADETALLY_DB_NAME}
      - JWT_SECRET=${TRADETALLY_JWT_SECRET}
      - JWT_EXPIRES_IN=${TRADETALLY_JWT_EXPIRES_IN}
      - ACCESS_TOKEN_EXPIRE=${TRADETALLY_ACCESS_TOKEN_EXPIRE}
      - REFRESH_TOKEN_EXPIRE=${TRADETALLY_REFRESH_TOKEN_EXPIRE}
      - MAX_DEVICES_PER_USER=${TRADETALLY_MAX_DEVICES}
      - ENABLE_DEVICE_TRACKING=${TRADETALLY_ENABLE_DEVICE_TRACKING}
      - FRONTEND_URL=${TRADETALLY_FRONTEND_URL}
      - VITE_API_URL=${TRADETALLY_VITE_API_URL}
      - CORS_ORIGINS=${TRADETALLY_CORS_ORIGINS}
      - EMAIL_HOST=${TRADETALLY_EMAIL_HOST}
      - EMAIL_PORT=${TRADETALLY_EMAIL_PORT}
      - EMAIL_USER=${TRADETALLY_EMAIL_USER}
      - EMAIL_PASS=${TRADETALLY_EMAIL_PASS}
      - EMAIL_FROM=${TRADETALLY_EMAIL_FROM}
      - REGISTRATION_MODE=${TRADETALLY_REGISTRATION_MODE}
      - ENABLE_SWAGGER=${TRADETALLY_ENABLE_SWAGGER}
      - RUN_MIGRATIONS=${TRADETALLY_RUN_MIGRATIONS}
      - BILLING_ENABLED=${TRADETALLY_BILLING_ENABLED}
      - STRIPE_SECRET_KEY=${TRADETALLY_STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${TRADETALLY_STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${TRADETALLY_STRIPE_WEBHOOK_SECRET}
    volumes:
      - ./config:/app/config
    ports:
      - "${TRADETALLY_PORT}:80"
    networks:
      - web
      - tradetally-internal
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.tradetally-http.rule=Host(`${TRADETALLY_DOMAIN}`)"
        - "traefik.http.routers.tradetally-http.entrypoints=web"
        - "traefik.http.routers.tradetally-http.middlewares=redirect-to-https"
        - "traefik.http.routers.tradetally-https.rule=Host(`${TRADETALLY_DOMAIN}`)"
        - "traefik.http.routers.tradetally-https.entrypoints=websecure"
        - "traefik.http.routers.tradetally-https.tls=true"
        - "traefik.http.routers.tradetally-https.tls.certresolver=letsencrypt"
        - "traefik.http.services.tradetally.loadbalancer.server.port=80"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

networks:
  web:
    external: true
  tradetally-internal:
    driver: overlay

volumes:
  tradetally_redis_data:

