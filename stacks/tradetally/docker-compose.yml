version: '3.8'

services:
  tradetally-postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=${TRADETALLY_DB_NAME:-tradetally}
      - POSTGRES_USER=${TRADETALLY_DB_USER:-tradetally}
      - POSTGRES_PASSWORD=${TRADETALLY_DB_PASSWORD}
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    networks:
      - tradetally-internal
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

  tradetally:
    image: ${TRADETALLY_IMAGE:-potentialmidas/tradetally:latest}
    environment:
      - DATABASE_URL=postgresql://${TRADETALLY_DB_USER:-tradetally}:${TRADETALLY_DB_PASSWORD}@tradetally-postgres:5432/${TRADETALLY_DB_NAME:-tradetally}
      - REDIS_URL=redis://tradetally-redis:6379
      - SECRET_KEY=${TRADETALLY_SECRET_KEY}
      - DEBUG=${TRADETALLY_DEBUG:-false}
      - ALLOWED_HOSTS=${TRADETALLY_DOMAIN:-tradetally.${DOMAIN}}
    volumes:
      - ./config:/app/config
    ports:
      - "${TRADETALLY_PORT:-8001}:8000"
    networks:
      - web
      - tradetally-internal
    depends_on:
      - tradetally-postgres
      - tradetally-redis
    deploy:
      labels:
        - "traefik.enable=true"
        # HTTP router (redirects to HTTPS)
        - "traefik.http.routers.tradetally-http.rule=Host(`${TRADETALLY_DOMAIN:-tradetally.${DOMAIN}}`)"
        - "traefik.http.routers.tradetally-http.entrypoints=web"
        - "traefik.http.routers.tradetally-http.middlewares=redirect-to-https"
        # HTTPS router
        - "traefik.http.routers.tradetally-https.rule=Host(`${TRADETALLY_DOMAIN:-tradetally.${DOMAIN}}`)"
        - "traefik.http.routers.tradetally-https.entrypoints=websecure"
        - "traefik.http.routers.tradetally-https.tls=true"
        - "traefik.http.routers.tradetally-https.tls.certresolver=letsencrypt"
        - "traefik.http.services.tradetally.loadbalancer.server.port=8000"
        # Middleware for HTTP to HTTPS redirect
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

  tradetally-redis:
    image: redis:7-alpine
    volumes:
      - tradetally_redis_data:/data
    networks:
      - tradetally-internal
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

networks:
  web:
    external: true
  tradetally-internal:
    driver: overlay

volumes:
  tradetally_redis_data: